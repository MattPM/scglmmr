<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sample-level Single-cell Generalized Linear Multilevel Models in R  • scglmmr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Sample-level Single-cell Generalized Linear Multilevel Models in R ">
<meta property="og:description" content="group and sample level comparisons for single cell data with multlevel models ">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">scglmmr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/scglmmr_pseudobulk.html">Pseudobulk differential expression with nested group repeated measures single cell experiment designs using scglmmr</a>
    </li>
    <li>
      <a href="articles/scglmmr_singlecell.html">Single cell gene and module level differential expression with nested group repeated measures experiment designs using scglmmr</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MattPM/scglmmr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">

<p>scglmmr <em>S</em>ample-level <em>S</em>ingle-cell <em>G</em>eneralized <em>L</em>inear <em>M</em>ultilevel <em>M</em>odels in <em>R</em> ================ Matt Mulè</p>
<!-- README.md is generated from README.Rmd. Please edit that file -->
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/devtools/man/remote-reexports.html" class="external-link">install_github</a></span><span class="op">(</span>repo <span class="op">=</span> <span class="st">"https://github.com/MattPM/scglmmr"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/MattPM/scglmmr" class="external-link">scglmmr</a></span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="readme-updates-to-do">readme updates TO DO:<a class="anchor" aria-label="anchor" href="#readme-updates-to-do"></a>
</h2>
<p>add TOC<br>
add makeContrastsDream<br>
change the workflow to represent the most up to dat PB workflow<br>
Add Enrichmentjaccard<br>
add new single cell models module and gene level model</p>
</div>
<div class="section level2">
<h2 id="single-cell-within-cluster-perturbation-response-differential-expression">Single cell within cluster perturbation response differential expression<a class="anchor" aria-label="anchor" href="#single-cell-within-cluster-perturbation-response-differential-expression"></a>
</h2>
<p>The purpose of this software is to analyze single cell genomics data with pre and post perturbation measurements from the same individuals, including complex designs wehre individuals with repeated measurements are nested within in multiple response groups. The focus is on implementing flexible generalized linear multilevel models to derive group (i.e. good or poor clinical outcome, high or low rug response) and treatment associated effects <em>within cell types</em> defined either by protein (e.g. with CITE-seq data) or transcriptome based clustering followed by downstream enrichment testing and visualization.</p>
<p>By default, the effect of treatment/perturbation across all subjects, the baseline differences between outcome groups, and the difference in the treatment effect between the outcome groups are tested. Any number of model covariates can be specified and by default the package uses a random intercept model to accomodate the non-independence of expression within each subject.</p>
<p>An overview of scglmmr methods:</p>
<div class="section level3">
<h3 id="pseudobulk-mixed-effects-models">1. pseudobulk mixed effects models<a class="anchor" aria-label="anchor" href="#pseudobulk-mixed-effects-models"></a>
</h3>
<p>These functions implement convenience wrappers around both <code>limma</code> for fitting traditional linear models (for e.g. baseline differenced between groups) and the <code>dream</code> method from the <code>variancePartition</code> package. This is the only pseudobulk differential expression method that can accomodate both fixed and random effects (which are statistically necessary to account for non-independence of multiple measurements from the same donor) via use of <code>lme4</code> for mixed effects modeling while accounting for measurement uncertainty via pooling unqeual library sizes by incorporating <code>voom</code> observational weights. This method performed well in related simulation studies by <a href="https://www.nature.com/articles/s41467-020-19894-4" class="external-link">Crowell et. al. 2020</a>. scglmmr performs statistical contrasts between groups comparing the least squares means after accounting for model covariates is empowered by the <a href="https://cran.r-project.org/web/packages/emmeans/index.html" class="external-link">emmeans</a> package.</p>
</div>
<div class="section level3">
<h3 id="single-cell-gene-level-mixed-effects-models">2. single cell gene level mixed effects models<a class="anchor" aria-label="anchor" href="#single-cell-gene-level-mixed-effects-models"></a>
</h3>
<p>A function for implemeting single cell gene-level poisson GLMM within clusters.</p>
</div>
<div class="section level3">
<h3 id="single-cell-module-level-mixed-effect-models">3. single cell module level mixed effect models<a class="anchor" aria-label="anchor" href="#single-cell-module-level-mixed-effect-models"></a>
</h3>
<p>Functions for calculating single cell weighted and non weighted module scores with mixed effects models fit on these module scores.</p>
</div>
<div class="section level3">
<h3 id="downstream-enrichment-testing-and-visualization">4. Downstream enrichment testing and visualization<a class="anchor" aria-label="anchor" href="#downstream-enrichment-testing-and-visualization"></a>
</h3>
<p>scglmmr implements enrichment testing of pseudobulk or single cell results with wrappers around methods from the <a href="https://www.biorxiv.org/content/10.1101/060012v2#disqus_thread" class="external-link">fast set gene enrichment (fgsea)</a> and <a href="https://www.bioconductor.org/packages/release/bioc/html/clusterProfiler.html" class="external-link">clusterProfiler</a> R packages.</p>
</div>
<div class="section level3">
<h3 id="philosophy">Philosophy<a class="anchor" aria-label="anchor" href="#philosophy"></a>
</h3>
<p>The scglmmr package considers each cluster/ cell type as a separate ‘experiment’ similar to fitting separate models to different FACS sorted leukocyte subsets followed by RNAseq. Clusters can be defined by transcriptome clustering and the approach is particularly well suited for CITE-seq data with cells clustered based on normalized protein expression levels which can be improved by normalizing and denoising with our method, <a href="https://github.com/niaid/dsb" class="external-link">dsb</a>.</p>
<p><strong>Experiment designs (within each cluster / celltype) supported by scglmmr</strong> Below is a 2 group repeated measures experiment. A random intercept model is required to account for autocorrelation in each donors post perturbation response with their baseline level of expression. This data can be accomodated by scglmmr. More simple experiment designs are also supported, for example data with 2 groups but not repeated pre/post treatment measurements, see the <code><a href="reference/RunVoomLimma.html">RunVoomLimma()</a></code> function.</p>
<table class="table">
<thead><tr class="header">
<th align="left">sample</th>
<th align="center">sampleid</th>
<th align="right">timepoint</th>
<th align="left">Group</th>
<th align="center">sex</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">101_t0</td>
<td align="center">101</td>
<td align="right">d0</td>
<td align="left">good</td>
<td align="center">F</td>
</tr>
<tr class="even">
<td align="left">101_t1</td>
<td align="center">101</td>
<td align="right">d1</td>
<td align="left">poor</td>
<td align="center">F</td>
</tr>
<tr class="odd">
<td align="left">102_t0</td>
<td align="center">102</td>
<td align="right">d0</td>
<td align="left">good</td>
<td align="center">M</td>
</tr>
<tr class="even">
<td align="left">102_t1</td>
<td align="center">102</td>
<td align="right">d1</td>
<td align="left">poor</td>
<td align="center">M</td>
</tr>
<tr class="odd">
<td align="left">… (x n donors)</td>
<td align="center">… (x n donors)</td>
<td align="right">… (x n donors)</td>
<td align="left">… (x n donors)</td>
<td align="center">… (x n donors)</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="pseudobulk-mixed-effects-model">1. “Pseudobulk” mixed effects model<a class="anchor" aria-label="anchor" href="#pseudobulk-mixed-effects-model"></a>
</h3>
<p>In the case of pseudobulk libraries derived from single cell RNAseq data, interpolated model weights should correlate with library sizes within each cell type. Indeed we confirmed that the log count per million and square root standard deviation of genes had the expected monotonically decreasing trend within each cell type and that the resulting interpolated model weights across genes in a given sample were highly correlated with both the number of cells used to create the library and the sample’s total mRNA library size. Later, a more recent report introduced the muscat R package and simulation studies for testing within cluster differential expression. 10.1101/713412. This paper included simulation and validation studies of established bulk RNAseq methods for within cluster differential expression analysis. In that report, a pseudobulk method that performed particularly well was using limma with voom observational weights, and mixed effects (i.e. the ability to specify a random effect for donor baseline expression) with lme4 model formula implemented through the “dream” method available through the vairance partition package. We implemented a weighted mixed effects model using this limma + voom + lme4 method within each cell type using a random intercept for each donor with contrast coding to test for group level fold change differences.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#devtools::install_github(repo = "https://github.com/MattPM/scglmmr")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/MattPM/scglmmr" class="external-link">scglmmr</a></span><span class="op">)</span>
<span class="va">datapath</span> <span class="op">=</span> <span class="st">"mypath/"</span>

<span class="co"># load seurat or sce object etc. </span>
<span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"path/seuratobject.rds"</span><span class="op">)</span>

<span class="co"># define counts and metadata and subset to cells above rm seurat object from workspace </span>
<span class="va">meta</span> <span class="op">=</span> <span class="va">s</span><span class="op">@</span><span class="va">meta.data</span>
<span class="va">umi</span> <span class="op">=</span> <span class="va">s</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">@</span><span class="va">counts</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># QC contingency of cells by subject for each celltype </span>
<span class="va">tab</span> <span class="op">=</span> <span class="fu">scglmmr</span><span class="fu">::</span><span class="fu"><a href="reference/SubjectCelltypeTable.html">SubjectCelltypeTable</a></span><span class="op">(</span>metadata <span class="op">=</span> <span class="va">meta</span>, celltype_column <span class="op">=</span> <span class="st">"lineage"</span>, sample_column <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span>
<span class="va">tab</span><span class="op">$</span><span class="va">celltypes_remove</span>; <span class="va">tab</span><span class="op">$</span><span class="va">`low representation celltypes`</span>; <span class="va">tab</span><span class="op">$</span><span class="va">table</span>

<span class="co"># remove cells prior to pseudobulk analysis </span>
<span class="va">meta</span> <span class="op">=</span> <span class="va">meta</span><span class="op">[</span><span class="op">!</span><span class="va">meta</span><span class="op">$</span><span class="va">celltype_label_3</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">tab</span><span class="op">$</span><span class="va">celltypes_remove</span>, <span class="op">]</span>

<span class="co"># subset data </span>
<span class="va">umi</span> <span class="op">=</span> <span class="va">umi</span><span class="op">[</span> ,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">meta</span><span class="op">)</span><span class="op">]</span>

<span class="co"># pseudobulk workflow </span>
<span class="va">pb</span> <span class="op">=</span> <span class="fu">scglmmr</span><span class="fu">::</span><span class="fu"><a href="reference/PseudobulkList.html">PseudobulkList</a></span><span class="op">(</span>rawcounts <span class="op">=</span> <span class="va">umi</span>, metadata <span class="op">=</span> <span class="va">meta</span>, sample_col <span class="op">=</span> <span class="st">"sample"</span>,
                             celltype_col <span class="op">=</span> <span class="st">"lineage"</span>, avg_or_sum <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span>
<span class="va">designmat</span> <span class="op">=</span> <span class="fu">scglmmr</span><span class="fu">::</span><span class="fu"><a href="reference/BulkDesignMatrix.html">BulkDesignMatrix</a></span><span class="op">(</span>metadata <span class="op">=</span> <span class="va">meta</span>, sample_column <span class="op">=</span> <span class="st">"sample"</span>,
                                      variable_column <span class="op">=</span> <span class="st">"cohort_timepoint"</span>, pseudobulklist <span class="op">=</span> <span class="va">pb</span><span class="op">)</span>
<span class="va">dge</span> <span class="op">=</span> <span class="fu">scglmmr</span><span class="fu">::</span><span class="fu"><a href="reference/NormalizePseudobulk.html">NormalizePseudobulk</a></span><span class="op">(</span>pseudobulklist <span class="op">=</span> <span class="va">pb</span>, design_matrix <span class="op">=</span> <span class="va">designmat</span>, minimum.gene.count <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>

<span class="co"># custom a priori contrasts over a combined factor of the group and timepoint variables </span>
<span class="va">c_mat</span> <span class="op">=</span> <span class="fu">makeContrasts</span><span class="op">(</span>
  foldchange_difference <span class="op">=</span> <span class="op">(</span><span class="va">group_timepoint1_1</span> <span class="op">-</span> <span class="va">group_timepoint1_0</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="va">group_timepoint0_1</span> <span class="op">-</span> <span class="va">group_timepoint0_0</span><span class="op">)</span>,
  time1_foldchange <span class="op">=</span> <span class="op">(</span><span class="va">group_timepoint1_1</span> <span class="op">+</span> <span class="va">group_timepoint0_1</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>  <span class="op">-</span> <span class="op">(</span><span class="va">group_timepoint1_0</span> <span class="op">+</span> <span class="va">group_timepoint0_0</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>,
  baseline_groups <span class="op">=</span> <span class="op">(</span><span class="va">group_timepoint1_0</span> <span class="op">-</span> <span class="va">group_timepoint0_0</span><span class="op">)</span>,
  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">designmat</span><span class="op">)</span>
<span class="op">)</span>

<span class="co">#### REPLACE THE ABOVE WITH makeContrastsDream see v3aso3 contrast model in fsc. </span>


  
<span class="co"># fit mixed model for the multi timepoint contrasts </span>
<span class="va">fit</span> <span class="op">=</span> <span class="fu">scglmmr</span><span class="fu">::</span><span class="fu"><a href="reference/dreamMixedModel.html">dreamMixedModel</a></span><span class="op">(</span>dge_lists <span class="op">=</span> <span class="va">dge</span>, 
                               apriori_contrasts <span class="op">=</span> <span class="cn">TRUE</span>, 
                               sample_column <span class="op">=</span> <span class="st">'sample'</span>,
                               cell_metadata <span class="op">=</span> <span class="va">meta</span>, 
                               contrast_matrix <span class="op">=</span> <span class="va">c_mat</span>, 
                               design_matrix <span class="op">=</span> <span class="va">designmat</span>, 
                               lme4_formula <span class="op">=</span>  <span class="st">'~ 0 + age + gender + cohort_timepoint + (1|sampleid)'</span>, 
                               fixed_effects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'age'</span>, <span class="st">'gender'</span>, <span class="st">'cohort_timepoint'</span><span class="op">)</span>, 
                               plotsavepath <span class="op">=</span> <span class="va">figpath</span>, 
                               ncores <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>

<span class="co"># fit simple linear model for the baseline group level contrast </span>
<span class="va">bl</span> <span class="op">=</span> <span class="fu">scglmmr</span><span class="fu">::</span><span class="fu"><a href="reference/RunVoomLimma.html">RunVoomLimma</a></span><span class="op">(</span>dgelists <span class="op">=</span> <span class="va">dge</span>, 
                           design_matrix <span class="op">=</span> <span class="va">designmat</span>, 
                           do_contrast_fit <span class="op">=</span> <span class="cn">T</span>,
                           my_contrast_matrix <span class="op">=</span> <span class="va">c_mat</span><span class="op">[</span> ,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>

<span class="co"># save </span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">bl</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">datapath</span>, <span class="st">"blfit_object.rds"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">fit</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">datapath</span>, <span class="st">"fit_object.rds"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="downstream-analysis-on-pseudobulk-results">Downstream analysis on pseudobulk results<a class="anchor" aria-label="anchor" href="#downstream-analysis-on-pseudobulk-results"></a>
</h3>
<p>Here we provide examples of downstream analysis on results of the model fit above focusing on the first contrast (the first coefficient in the results), corresponding to:<br>
foldchange_difference = (group_timepoint1_1 - group_timepoint1_0) - (group_timepoint0_1 - group_timepoint0_0)</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># hlmk = readRDS(file = here("signature_curation/hallmark.rds"))</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">figpath =<span class="st"> "your/path"</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">test =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw">GetRankResults</span>(<span class="dt">limma.fit.object.list =</span> bl, <span class="dt">coefficient.number =</span> <span class="dv">1</span>, <span class="st">"test"</span>)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">res =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw">GetContrastResults</span>(<span class="dt">limma.fit.object.list =</span> bl, <span class="dt">coefficient.number =</span> <span class="dv">1</span>, <span class="dt">contrast.name =</span> <span class="st">"test"</span>)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co"># get the mixed effects model results for the difference in fold changes </span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">fit_res =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw">GetContrastResultsRaw</span>(<span class="dt">limma.fit.object.list =</span> fit, </a>
<a class="sourceLine" id="cb3-8" data-line-number="8">                                         <span class="dt">coefficient.number =</span> <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb3-9" data-line-number="9">                                         <span class="dt">contrast.name =</span> <span class="st">"foldchangedifference"</span>)</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">fit_rank =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw">GetRankResultsRaw</span>(<span class="dt">contrast.result.raw.list =</span> fit_res)</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co"># Gene Set Enrichment Analysis </span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">gsea1 =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw">RunFgseaOnRankList</span>(<span class="dt">rank.list.celltype =</span> test, <span class="dt">pathways =</span> hlmk)</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">d =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw">RbindGseaResultList</span>(<span class="dt">gsea_result_list =</span> gsea1,<span class="dt">NES_filter =</span> <span class="op">-</span><span class="ot">Inf</span>,<span class="dt">padj_filter =</span> <span class="fl">0.2</span>)</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">scglmmr<span class="op">::</span><span class="kw">GSEABubblePlot</span>(d, <span class="dt">save_path =</span> figpath, <span class="dt">save_name =</span> <span class="st">"plot.pdf"</span>)</a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="co"># also see scglmmr::GSEABarPlot()</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="co"># full set of leading edge genes vs celltypes </span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20">lefull =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw">GetLeadingEdgeFull</span>(<span class="dt">gsea.list =</span> gsea1, <span class="dt">padj.filter =</span> <span class="fl">0.1</span>,<span class="dt">NES.filter =</span> <span class="op">-</span><span class="ot">Inf</span>)</a>
<a class="sourceLine" id="cb3-21" data-line-number="21"></a>
<a class="sourceLine" id="cb3-22" data-line-number="22"><span class="co"># combine GSEA results with model coefficient for each gene in leading edge </span></a>
<a class="sourceLine" id="cb3-23" data-line-number="23">cr =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw">CombineResults</span>(<span class="dt">gsealist =</span> gsea1, <span class="dt">contrastlist =</span> res, <span class="dt">gseafdr =</span> <span class="fl">0.1</span>, <span class="dt">genefdr =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb3-24" data-line-number="24"></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"><span class="co"># make tidy average data for visualization of weighted pb results </span></a>
<a class="sourceLine" id="cb3-27" data-line-number="27">av =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw">PseudobulkList</span>(<span class="dt">rawcounts =</span> umi, </a>
<a class="sourceLine" id="cb3-28" data-line-number="28">                             <span class="dt">metadata =</span> meta, </a>
<a class="sourceLine" id="cb3-29" data-line-number="29">                             <span class="dt">sample_col =</span> <span class="st">"sample"</span>, </a>
<a class="sourceLine" id="cb3-30" data-line-number="30">                             <span class="dt">celltype_col =</span> <span class="st">"celltype"</span>,</a>
<a class="sourceLine" id="cb3-31" data-line-number="31">                             <span class="dt">avg_or_sum =</span> <span class="st">'average'</span>)</a>
<a class="sourceLine" id="cb3-32" data-line-number="32">le_expr =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw">LeadEdgeTidySampleExprs</span>(<span class="dt">av.exprs.list =</span> av,</a>
<a class="sourceLine" id="cb3-33" data-line-number="33">                                           <span class="dt">gsea.list =</span> hlmk_ctm0, </a>
<a class="sourceLine" id="cb3-34" data-line-number="34">                                           <span class="dt">padj.filter =</span> <span class="fl">0.1</span>,</a>
<a class="sourceLine" id="cb3-35" data-line-number="35">                                           <span class="dt">NES.filter =</span> <span class="op">-</span><span class="ot">Inf</span>)</a>
<a class="sourceLine" id="cb3-36" data-line-number="36"></a>
<a class="sourceLine" id="cb3-37" data-line-number="37"></a>
<a class="sourceLine" id="cb3-38" data-line-number="38"><span class="co"># example plot of sample level average leading edge genes annotated </span></a>
<a class="sourceLine" id="cb3-39" data-line-number="39">scglmmr<span class="op">::</span><span class="kw">LeadEdgeSampleHeatmap</span>(<span class="dt">tidy.exprs.list =</span> le_expr,</a>
<a class="sourceLine" id="cb3-40" data-line-number="40">                               <span class="dt">modulename =</span> <span class="st">"MODULENAME"</span>,</a>
<a class="sourceLine" id="cb3-41" data-line-number="41">                               <span class="dt">elltype_plot =</span> <span class="st">"TCELL"</span>,</a>
<a class="sourceLine" id="cb3-42" data-line-number="42">                               <span class="dt">metadata =</span> meta, </a>
<a class="sourceLine" id="cb3-43" data-line-number="43">                               <span class="dt">metadata_annotate =</span> <span class="kw">c</span>(<span class="st">'group'</span>, <span class="st">'timepoint'</span>, <span class="st">'age'</span>, <span class="st">'gender'</span>),</a>
<a class="sourceLine" id="cb3-44" data-line-number="44">                               <span class="dt">sample_column =</span> <span class="st">'sample'</span>,</a>
<a class="sourceLine" id="cb3-45" data-line-number="45">                               <span class="dt">returnmat =</span> F, </a>
<a class="sourceLine" id="cb3-46" data-line-number="46">                               <span class="dt">savepath =</span> figpath, </a>
<a class="sourceLine" id="cb3-47" data-line-number="47">                               <span class="dt">savename =</span> <span class="st">"filename"</span>)</a>
<a class="sourceLine" id="cb3-48" data-line-number="48"></a>
<a class="sourceLine" id="cb3-49" data-line-number="49"><span class="co"># see also: </span></a>
<a class="sourceLine" id="cb3-50" data-line-number="50"><span class="co"># scglmmr::TopGenesTidySampleExprs() - same as aobve for 'top' de genes estimated by model coeffcient / p value. </span></a>
<a class="sourceLine" id="cb3-51" data-line-number="51"><span class="co"># scglmmr::GetTidySummary() - for custom plotting</span></a>
<a class="sourceLine" id="cb3-52" data-line-number="52"></a>
<a class="sourceLine" id="cb3-53" data-line-number="53"></a>
<a class="sourceLine" id="cb3-54" data-line-number="54"><span class="co"># repeat this for all enriched pathways </span></a>
<a class="sourceLine" id="cb3-55" data-line-number="55">heatpath =<span class="st"> </span><span class="kw">here</span>(<span class="st">"sime/path"</span>); <span class="kw">dir.create</span>(heatpath)</a>
<a class="sourceLine" id="cb3-56" data-line-number="56"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(le_expr)) {</a>
<a class="sourceLine" id="cb3-57" data-line-number="57">  cdat =<span class="st"> </span>le_expr[[i]]</a>
<a class="sourceLine" id="cb3-58" data-line-number="58">  ctype =<span class="st"> </span><span class="kw">names</span>(le_expr[i])</a>
<a class="sourceLine" id="cb3-59" data-line-number="59">  umod =<span class="st"> </span><span class="kw">unique</span>(cdat<span class="op">$</span>module)</a>
<a class="sourceLine" id="cb3-60" data-line-number="60">  <span class="cf">for</span> (u <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(umod)) {</a>
<a class="sourceLine" id="cb3-61" data-line-number="61">    scglmmr<span class="op">::</span><span class="kw">LeadEdgeSampleHeatmap</span>(<span class="dt">tidy.exprs.list =</span> le_expr, </a>
<a class="sourceLine" id="cb3-62" data-line-number="62">                          <span class="dt">modulename =</span> umod[u], </a>
<a class="sourceLine" id="cb3-63" data-line-number="63">                          <span class="dt">celltype_plot =</span> ctype,</a>
<a class="sourceLine" id="cb3-64" data-line-number="64">                          <span class="dt">metadata =</span> meta, <span class="dt">metadata_annotate =</span> <span class="kw">c</span>(<span class="st">'group'</span>, <span class="st">'timepoint'</span>, <span class="st">'age'</span>, <span class="st">'gender'</span>),</a>
<a class="sourceLine" id="cb3-65" data-line-number="65">                          <span class="dt">sample_column =</span> <span class="st">'sample'</span>,</a>
<a class="sourceLine" id="cb3-66" data-line-number="66">                          <span class="dt">returnmat =</span> F, </a>
<a class="sourceLine" id="cb3-67" data-line-number="67">                          <span class="dt">savepath =</span> heatpath,</a>
<a class="sourceLine" id="cb3-68" data-line-number="68">                          <span class="dt">savename =</span> <span class="kw">paste0</span>(ctype, <span class="st">" "</span>,umod[u],<span class="st">'.pdf'</span>))</a>
<a class="sourceLine" id="cb3-69" data-line-number="69">  }</a>
<a class="sourceLine" id="cb3-70" data-line-number="70">}</a>
<a class="sourceLine" id="cb3-71" data-line-number="71"></a>
<a class="sourceLine" id="cb3-72" data-line-number="72"><span class="co"># plot only the leading edge genes from enrichment in a heatmap of log Fold Change estimated for a model contrast </span></a>
<a class="sourceLine" id="cb3-73" data-line-number="73">le =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw">GetLeadingEdgeFull</span>(<span class="dt">gsea.list =</span> gsea1, <span class="dt">padj.filter =</span> <span class="fl">0.1</span>, <span class="dt">NES.filter =</span> <span class="op">-</span><span class="ot">Inf</span>)</a>
<a class="sourceLine" id="cb3-74" data-line-number="74">genesub =<span class="st"> </span><span class="kw">do.call</span>(rbind, le) <span class="op">%$%</span><span class="st"> </span>gene <span class="op">%&gt;%</span><span class="st"> </span>unique </a>
<a class="sourceLine" id="cb3-75" data-line-number="75">mtx2 =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw">GetGeneMatrix</span>(<span class="dt">result.list =</span> res, </a>
<a class="sourceLine" id="cb3-76" data-line-number="76">                    <span class="dt">stat_for_matrix =</span> <span class="st">"logFC"</span>,</a>
<a class="sourceLine" id="cb3-77" data-line-number="77">                    <span class="dt">gene_subset =</span> genesub, </a>
<a class="sourceLine" id="cb3-78" data-line-number="78">                    <span class="dt">pvalfilter =</span> <span class="op">-</span><span class="ot">Inf</span>, </a>
<a class="sourceLine" id="cb3-79" data-line-number="79">                    <span class="dt">logfcfilter =</span> <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb3-80" data-line-number="80"></a>
<a class="sourceLine" id="cb3-81" data-line-number="81">pheatmap<span class="op">::</span><span class="kw">pheatmap</span>(mtx2,</a>
<a class="sourceLine" id="cb3-82" data-line-number="82">                   <span class="dt">breaks =</span><span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">2</span>,<span class="dt">length.out =</span> <span class="dv">99</span>),</a>
<a class="sourceLine" id="cb3-83" data-line-number="83">                   <span class="dt">filename =</span> <span class="kw">paste0</span>(figpath,<span class="st">"LEgenes_heatmap.pdf"</span>))</a>
<a class="sourceLine" id="cb3-84" data-line-number="84"></a>
<a class="sourceLine" id="cb3-85" data-line-number="85"></a>
<a class="sourceLine" id="cb3-86" data-line-number="86"></a>
<a class="sourceLine" id="cb3-87" data-line-number="87"><span class="co">### Hypergeometric erichment </span></a>
<a class="sourceLine" id="cb3-88" data-line-number="88"><span class="kw">load</span>(termdf) <span class="co"># this term2gene dataframe is included in the package see clusterProfiler</span></a>
<a class="sourceLine" id="cb3-89" data-line-number="89">hyp =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw">RunHypergeometricTest</span>(<span class="dt">result_list =</span> fit_res,</a>
<a class="sourceLine" id="cb3-90" data-line-number="90">                                     <span class="dt">TERM2GENE_dataframe =</span> termdf,</a>
<a class="sourceLine" id="cb3-91" data-line-number="91">                                     <span class="dt">pval_threshold =</span> <span class="fl">0.1</span>,</a>
<a class="sourceLine" id="cb3-92" data-line-number="92">                                     <span class="dt">logFC_threshold =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb3-93" data-line-number="93">                                     <span class="dt">usefdr_threshold =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb3-94" data-line-number="94"><span class="co"># plot results </span></a>
<a class="sourceLine" id="cb3-95" data-line-number="95">scglmmr<span class="op">::</span><span class="kw">PlotHypergeometric</span>(<span class="dt">hyperg_result =</span> hyp, </a>
<a class="sourceLine" id="cb3-96" data-line-number="96">                            <span class="dt">p.adjust.filter =</span> <span class="fl">0.1</span>,</a>
<a class="sourceLine" id="cb3-97" data-line-number="97">                            <span class="dt">genenumber_filter =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb3-98" data-line-number="98">                            <span class="dt">savepath =</span> figpath,</a>
<a class="sourceLine" id="cb3-99" data-line-number="99">                            <span class="dt">savename =</span> <span class="st">"name"</span>, </a>
<a class="sourceLine" id="cb3-100" data-line-number="100">                            <span class="dt">title =</span> <span class="st">"title"</span>)</a>
<a class="sourceLine" id="cb3-101" data-line-number="101"></a>
<a class="sourceLine" id="cb3-102" data-line-number="102"><span class="co"># calculate average module z score across samples (z score across samples of gene z scores)</span></a>
<a class="sourceLine" id="cb3-103" data-line-number="103"><span class="co"># baseline_samples = c('') # user defined vector </span></a>
<a class="sourceLine" id="cb3-104" data-line-number="104"><span class="kw">lapply</span>(av, <span class="cf">function</span>(x), x[ ,baseline_samples])</a>
<a class="sourceLine" id="cb3-105" data-line-number="105">mz =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw">AverageSampleModuleZscore</span>(<span class="dt">average.metacell.list =</span> av,</a>
<a class="sourceLine" id="cb3-106" data-line-number="106">                                        <span class="dt">module.list =</span> hlmk,<span class="dt">use.module.subset =</span> F)</a></code></pre></div>
</div>
<div class="section level3">
<h3 id="single-cell-gene-level-de-testing">2. Single cell gene level DE testing<a class="anchor" aria-label="anchor" href="#single-cell-gene-level-de-testing"></a>
</h3>
<p>This single cell level models of differential expression pre and post treatment testing of genes by fitting a Poisson mixed glm. You specify a reduced and full model formula to extract p values and effect sizes.</p>
<p>Recommended: The function accepts an argument ‘celltype_genes_test’ this is a named list indexed by celltypes.</p>
<p>First we load a single cell object an define highly variable genes within each celltype, this can be done many different ways.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Single cell mixed model. </span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/MattPM/scglmmr" class="external-link">scglmmr</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1990</span><span class="op">)</span>

<span class="va">datapath</span> <span class="op">=</span> <span class="st">'your_path_to_save_results'</span>
<span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">'path_to_seurat_or_SingleCellExperimentObject'</span><span class="op">)</span>

<span class="co"># define highly variable genes within each cell type </span>
<span class="va">gene_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">s</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">celltype</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">gene_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">celltype_joint</span> <span class="op">==</span> <span class="va">celltype_unique</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> 
    <span class="fu">Seurat</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Seurat/man/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,top.genes <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span>
  <span class="va">gene_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu">Seurat</span><span class="fu">::</span><span class="fu">VariableGenes</span><span class="op">(</span><span class="va">gene_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># one can also use scran trendVar etc. </span></code></pre></div>
<p>Now we run the single cell Poisson model by specifying a model formula, the formula must have the LHS equal to <code>gene ~</code> and include a random effect term <code>(1|subjectid)</code>. the variable that corresponds to the perturbation variable as a 2 level factor with pre and post perturbation measurements (repeated measurements for the same subject denoted by <code>subjectid</code> must be identified, for example, if the metadata variable coding for the time post perturbation is called treatment.time, then the model formula could be <code>f1 = 'gene ~ offset(log(nUMI)) + treatment.time + (1|subjectid)'</code> with this model one would set the argument <code>test_variable = treatment.time</code> which should have 2 ordered levels corresponding to pre and post treatment. Within the function, the <code>emmeans</code> package automatically tests the difference in the marginal means of the post vs pre perturbation effect.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># load subset of genes to test for each celltype </span>
<span class="va">gene_union</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">genes_test</span><span class="op">)</span><span class="op">)</span>

<span class="co"># create day 1 metadata dataframe from a single cell object (seurat, SingleCellExperiment etc.)</span>
<span class="va">s</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">subjectid</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">s</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">sampleid</span><span class="op">)</span><span class="op">)</span>

<span class="co"># create metadata for lme4</span>
<span class="va">md</span> <span class="op">=</span> <span class="va">s</span><span class="op">@</span><span class="va">meta.data</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">barcode_check</span>, <span class="va">batch</span>, <span class="va">subjectid</span>, <span class="va">timepoint</span>, <span class="va">celltype_joint</span>, <span class="va">nUMI</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu">mutate</span><span class="op">(</span>timepoint <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">timepoint</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"d0"</span>, <span class="st">"d1"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">rename</span><span class="op">(</span>celltype <span class="op">=</span> <span class="va">celltype_joint</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">column_to_rownames</span><span class="op">(</span><span class="st">'barcode_check'</span><span class="op">)</span>

<span class="co"># get gene data </span>
<span class="va">gene_data</span> <span class="op">=</span> <span class="fu">Matrix</span><span class="fu">::</span><span class="fu">t</span><span class="op">(</span><span class="va">s</span><span class="op">@</span><span class="va">raw.data</span><span class="op">[</span><span class="va">gene_union</span>, <span class="op">]</span><span class="op">)</span>

<span class="co"># we can now remove whatever single cell object was loaded in the environment. </span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## specify model formula </span>
<span class="va">f1</span> <span class="op">=</span> <span class="st">'gene ~ offset(log(nUMI)) + timepoint + (1|subjectid)'</span>

<span class="co"># method 1</span>
<span class="va">results</span> <span class="op">=</span> <span class="fu">scglmmr</span><span class="fu">::</span><span class="fu"><a href="reference/SCMixedPoisson.html">SCMixedPoisson</a></span><span class="op">(</span>gene_data <span class="op">=</span> <span class="va">gene_data</span>,
                                  metadata <span class="op">=</span> <span class="va">md</span>,
                                  model_formula <span class="op">=</span> <span class="va">f1</span>, 
                                  test_variable <span class="op">=</span> <span class="st">'timepoint'</span>,
                                  celltype_genes_test <span class="op">=</span> <span class="va">genes_test</span>,
                                  save_path <span class="op">=</span> <span class="va">datapath</span><span class="op">)</span>
<span class="co"># write results </span>
<span class="co"># data.table::fwrite(x = results,file = paste0(datapath, "/h1_sc_time_merged_v2.txt"), sep = '\t')</span></code></pre></div>
<p>Another way to specify the model automatically:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">results</span> <span class="op">=</span> <span class="fu">scglmmr</span><span class="fu">::</span><span class="fu"><a href="reference/SCMixedPoisson.html">SCMixedPoisson</a></span><span class="op">(</span>gene_data <span class="op">=</span> <span class="va">gene_data</span>,
                                  metadata <span class="op">=</span> <span class="va">md</span>,
                                  test_variable <span class="op">=</span> <span class="st">'timepoint'</span>,
                                  covariate_variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'BMI'</span>, <span class="st">'SEX'</span><span class="op">)</span>,
                                  celltype_genes_test <span class="op">=</span> <span class="va">genes_test</span>, 
                                  save_path <span class="op">=</span> <span class="va">datapath</span><span class="op">)</span></code></pre></div>
<p>This would automatically test the delta for pre and post perturbation calculating the marginal means over the coavariates BMI and SEX with the generalized linear mixed effects Poisson model: <code>'gene ~ BMI + SEX + timepoint + (1|subjectid)'</code>.</p>
</div>
<div class="section level3">
<h3 id="enrichment-of-single-cell-poisson-model-of-timepoint-effect-using-clusterprofiler">enrichment of single cell poisson model of timepoint effect using clusterprofiler<a class="anchor" aria-label="anchor" href="#enrichment-of-single-cell-poisson-model-of-timepoint-effect-using-clusterprofiler"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## enrichment on these results </span>

<span class="co">### plot enrichment with a hypergeometric test against the li BTM </span>
<span class="va">scd1</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span> <span class="va">results</span> , f <span class="op">=</span> <span class="va">mmres</span><span class="op">$</span><span class="va">celltype</span> <span class="op">)</span>
<span class="va">scd1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">scd1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="va">x</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">gene</span>, <span class="va">celltype</span>, <span class="va">estimate</span>, <span class="va">padj</span><span class="op">)</span>  <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="st">'logFC'</span><span class="op">=</span> <span class="va">fixed_effect</span>,  <span class="st">'P.Value'</span> <span class="op">=</span> <span class="va">padj</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="va">termdf</span><span class="op">)</span>
<span class="va">hypsc</span> <span class="op">=</span> <span class="fu">scglmmr</span><span class="fu">::</span><span class="fu"><a href="reference/RunHypergeometricTest.html">RunHypergeometricTest</a></span><span class="op">(</span>result_list <span class="op">=</span> <span class="va">scd1</span>, 
                                       TERM2GENE_dataframe <span class="op">=</span> <span class="va">term_df</span>,
                                       pval_threshold <span class="op">=</span> <span class="fl">0.05</span>,
                                       logFC_threshold <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>  
<span class="fu">scglmmr</span><span class="fu">::</span><span class="fu"><a href="reference/PlotHypergeometric.html">PlotHypergeometric</a></span><span class="op">(</span>hyperg_result <span class="op">=</span> <span class="va">hypsc</span>,
                            p.adjust.filter <span class="op">=</span> <span class="fl">0.05</span>,
                            genenumber_filter <span class="op">=</span> <span class="fl">2</span>,
                            savepath <span class="op">=</span> <span class="va">figpath</span>, 
                            savename <span class="op">=</span> <span class="st">"d1singlecell_hypergeometric_padj0.05.pdf"</span>, 
                            title <span class="op">=</span> <span class="st">"single cell 24h vs baseline gene_exprs ~ offset(nUMI) + timepoint + (1|subjectid) \n 
                            hypergeometric test LI BTM, FDR 0.05, gene filter n &gt; 2"</span>, 
                            height <span class="op">=</span> <span class="fl">5.5</span>, width <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="single-cell-module-level-testing-group-level-fold-change-comparisons">2. Single cell module level testing + group level fold change comparisons<a class="anchor" aria-label="anchor" href="#single-cell-module-level-testing-group-level-fold-change-comparisons"></a>
</h3>
<p>This is designed for testing the difference in single cell module activity scores between groups at baseline, between groups, post treatment across groups and the difference in treatment effect between groups using the same <em>a priori</em> contrast approach as in the pseudobulk method described above.</p>
<div class="section level4">
<h4 id="part-i">Part I<a class="anchor" aria-label="anchor" href="#part-i"></a>
</h4>
<p>You first fit a module score to each single cell. Options: <em>threshold</em> what percent of genes in the module must a cell express to get a score (i.e. of 0.1, if the cell has less than 10% of genes &gt;0 in the module don’t score) <em>return_weighted</em> whether to return the weighted module score which is the average * weight where weight = number of genes in the cell in that module with non-zeroexpression</p>
<p><em>cellwise_scaling</em> should the scores be scaled across cells? Not recommended unless you are testing only a single celltype. <em>Seurat_version</em> if this is set to “2” it will accomodate seurat v2, if set to “3” will accomodate v3</p>
</div>
<div class="section level4">
<h4 id="part-ii-fitting-models">Part II fitting models:<a class="anchor" aria-label="anchor" href="#part-ii-fitting-models"></a>
</h4>
<p><em>The SCGroupContrastGLMM Function</em> To simultaneously test the difference in the fold changes due to treatment (for example) the levels of the combined group + time factor "group_id have to be ordered as follows (can be any names, these are just the order): group1 timepoint 0, group1 timepoint 1, group2 timepoint 0, group2 timepoint 1</p>
<p>It is also possible to use custom contrasts by changing the argument to contrast_list from contrast_2 (automatically loaded) to something else.</p>
<p>Specify any lme4 model formula in the argument to f1, with the randomeffect term for subjectid set to <code>(1|sampleid)</code> which should have a pre and post perturbation measurement. <code>f1 = 'modulescore ~ age + gender + group_id + (1|sampleid)'</code></p>
<p>This function will also automatically save a helpful plot of the least squares means (the residual means of each group after accounting for covariates in the model) of the module over the levels of each combined group_timepoint factor.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># load data</span>
<span class="va">Seurat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"my_seurat_object.rds"</span><span class="op">)</span>

<span class="co"># add cellwise module score for each signature </span>
<span class="va">mod_scores</span> <span class="op">=</span> <span class="fu"><a href="reference/WeightedCellModuleScore.html">WeightedCellModuleScore</a></span><span class="op">(</span>seurat_object <span class="op">=</span> <span class="va">Seurat</span>,
                                     module_list <span class="op">=</span> <span class="va">btm</span>,
                                     threshold <span class="op">=</span> <span class="fl">0.1</span>,
                                     return_weighted <span class="op">=</span> <span class="cn">FALSE</span>, cellwise_scaling <span class="op">=</span> <span class="cn">FALSE</span>, 
                                     Seurat_version <span class="op">=</span> <span class="st">"2"</span><span class="op">)</span> 
<span class="va">Seurat</span> <span class="op">=</span> <span class="fu">AddMetaData</span><span class="op">(</span><span class="va">Seurat</span>,metadata <span class="op">=</span> <span class="va">mod_scores</span><span class="op">)</span>
<span class="va">module_n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sig_test</span><span class="op">)</span>

<span class="co"># set up module data frame </span>
<span class="va">module_df</span> <span class="op">=</span> <span class="va">Seurat</span><span class="op">@</span><span class="va">meta.data</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> <span class="fu">select</span><span class="op">(</span><span class="va">barcode_check</span>, <span class="va">celltype_joint</span>, <span class="va">module_n</span><span class="op">)</span> 

<span class="co"># format metadata as factors group_id is order leveled for contrast_fit = contrast(emm1, method = list( (c21 - c20) - (c11 - c10) ))</span>
<span class="va">md</span> <span class="op">=</span> <span class="va">Seurat</span><span class="op">@</span><span class="va">meta.data</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">mutate</span><span class="op">(</span>group_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">treat_time</span>,  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'pre_low'</span>, <span class="st">'post_low'</span>, <span class="st">'pre_high'</span>, <span class="st">'post_high'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu">mutate</span><span class="op">(</span>sampleid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sampleid</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">select</span><span class="op">(</span><span class="va">barcode_check</span>, <span class="va">celltype_joint</span>, <span class="va">sampleid</span>,  <span class="va">age</span>, <span class="va">group_id</span><span class="op">)</span>

<span class="co"># Fit mixed model </span>
<span class="va">plot_savepath</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">my_figure_save_path</span>, <span class="st">"/marginalmeans/"</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">plot_savepath</span><span class="op">)</span>

<span class="co"># specify any random intercept model e.g.</span>
<span class="va">f1</span> <span class="op">=</span> <span class="st">'modulescore ~ age + group_id + (1|sampleid)'</span>

<span class="co"># fit sc mod mixed model on ewighted module scores. </span>
<span class="va">mm_res</span> <span class="op">=</span> <span class="fu">SCGroupContrastGLMM</span><span class="op">(</span>module_data_frame <span class="op">=</span> <span class="va">module_df</span>, 
                             celltype_column <span class="op">=</span> <span class="st">'celltype'</span>,
                             metadata <span class="op">=</span> <span class="va">md</span>,
                             fixed_effects <span class="op">=</span> <span class="cn">NULL</span>,
                             lmer_formula <span class="op">=</span> <span class="va">f1</span>,
                             plotdatqc <span class="op">=</span> <span class="cn">TRUE</span>,
                             figpath <span class="op">=</span> <span class="st">'your/file/path'</span><span class="op">)</span>

<span class="co">### This function returns p values, effect sizes for baseline and difference in fld changes between the groups </span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mmres</span><span class="op">)</span>
<span class="co"># "celltype"                    "modulename"                  "contrasttime1vs0_group2vs1" </span>
<span class="co"># "estimatetime1vs0_group2vs1"  "std.errortime1vs0_group2vs1" "dftime1vs0_group2vs1"       </span>
<span class="co"># "z.ratiotime1vs0_group2vs1"   "p.valuetime1vs0_group2vs1"   "contrasttime0_group2vs1"    </span>
<span class="co"># "estimatetime0_group2vs1"     "std.errortime0_group2vs1"    "dftime0_group2vs1"          </span>
<span class="co"># "z.ratiotime0_group2vs1"      "p.valuetime0_group2vs1"      "d0 low_marginal_mean"       </span>
<span class="co"># "d1 low_marginal_mean"        "d0 high_marginal_mean"       "d1 high_marginal_mean"      </span>
<span class="co"># "formula"                     "statistictime1vs0_group2vs1" "statistictime0_group2vs1"   </span></code></pre></div>
<p>A plot like this will be generated for each module for each cell type with the estimated marginal means in the right margin and the actual single cell module score distribution across each level of group_id:</p>
<div class="figure">
<img src="https://user-images.githubusercontent.com/15280712/89591805-1f5a1200-d819-11ea-8b49-5b84477dd178.png" alt="image"><p class="caption">image</p>
</div>
<p><em>The WilcoxWithinCluster function</em> To run a simple test of baseline differences between groups, use the <em>WilcoxWithinCluster</em> function as below if you only have one timepoint but 2 outcome groups.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">######## baseline differences with a simple wilcox test </span>
<span class="va">weighted_score</span> <span class="op">=</span> <span class="fu"><a href="reference/WeightedCellModuleScore.html">WeightedCellModuleScore</a></span><span class="op">(</span>seurat_object <span class="op">=</span> <span class="va">s</span>, module_list <span class="op">=</span> <span class="va">sig</span>,
                                         threshold <span class="op">=</span> <span class="fl">0.1</span>, cellwise_scaling <span class="op">=</span> <span class="cn">FALSE</span>,
                                         return_weighted <span class="op">=</span> <span class="cn">TRUE</span>,
                                         Seurat_version <span class="op">=</span> <span class="st">"3"</span><span class="op">)</span>
 
<span class="co"># set module dataframe</span>
<span class="va">module_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>celltype_joint <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">s</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span>,
                  barcode_check <span class="op">=</span> <span class="va">s</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">barcode_full</span>,
                  <span class="va">weighted_score</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="op">)</span>
 
<span class="co"># format lme4 metadata (note here just wilcox so group IDS do not have to be lme4 factors</span>
<span class="va">meta_data</span> <span class="op">=</span> <span class="va">s</span><span class="op">@</span><span class="va">meta.data</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu">select</span><span class="op">(</span>celltype_joint <span class="op">=</span> <span class="va">seurat_clusters</span>,  barcode_check <span class="op">=</span> <span class="va">barcode_full</span>, <span class="va">sample</span>, group_id <span class="op">=</span> <span class="va">IRAE</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">group_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"poor_outcome"</span>, <span class="st">"good_outcome"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu">mutate</span><span class="op">(</span>group_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">group_id</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"poor_outcome"</span>, <span class="st">"good_outcome"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
 
<span class="co"># Fit wilcox test and do bonferonni correction </span>
<span class="va">plot_savepath2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">figpath</span>, <span class="st">"module_distribution/"</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">plot_savepath2</span><span class="op">)</span>
<span class="va">m2</span> <span class="op">=</span> <span class="va">module_df</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">barcode_check</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">meta_data</span><span class="op">$</span><span class="va">barcode_check</span> <span class="op">)</span>
<span class="va">cvnc</span> <span class="op">=</span> <span class="fu"><a href="reference/WilcoxWithinCluster.html">WilcoxWithinCluster</a></span><span class="op">(</span>module_data_frame <span class="op">=</span> <span class="va">m2</span>, lme4metadata <span class="op">=</span> <span class="va">meta_data</span>, plot_savepath <span class="op">=</span> <span class="va">plot_savepath2</span><span class="op">)</span>
<span class="va">cvnc</span><span class="op">$</span><span class="va">padj</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html" class="external-link">p.adjust</a></span><span class="op">(</span>p <span class="op">=</span> <span class="va">cvnc</span><span class="op">$</span><span class="va">p.value.t0.wilcox</span>, method <span class="op">=</span> <span class="st">"BH"</span><span class="op">)</span></code></pre></div>
<!-- badges: start -->
<!-- badges: end -->
<p>Questions? Pls open an issue.</p>
</div>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/MattPM/scglmmr/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/MattPM/scglmmr/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li>NA</li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing scglmmr</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Matthew Mulè <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0001-8457-2716" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>



  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Matthew Mulè.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
