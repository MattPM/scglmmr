<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Single cell gene and module level differential expression with nested group repeated measures experiment designs using scglmmr • scglmmr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Single cell gene and module level differential expression with nested group repeated measures experiment designs using scglmmr">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">scglmmr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/pseudobulk_mixed_effects.html">nested group repeated measures pseudobulk differential expression testing</a>
    </li>
    <li>
      <a href="../articles/scglmmr_pseudobulk.html">nested group repeated measures pseudobulk differential expression testing</a>
    </li>
    <li>
      <a href="../articles/scglmmr_singlecell.html">Single cell gene and module level differential expression with nested group repeated measures experiment designs using scglmmr</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MattPM/scglmmr">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Single cell gene and module level differential expression with nested group repeated measures experiment designs using scglmmr</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/MattPM/scglmmr/blob/master/vignettes/scglmmr_singlecell.Rmd"><code>vignettes/scglmmr_singlecell.Rmd</code></a></small>
      <div class="hidden name"><code>scglmmr_singlecell.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(scglmmr)</a></code></pre></div>
<div id="single-cell-gene-level-de-testing" class="section level3">
<h3 class="hasAnchor">
<a href="#single-cell-gene-level-de-testing" class="anchor"></a>2. Single cell gene level DE testing</h3>
<p>This single cell level models of differential expression pre and post treatment testing of genes by fitting a Poisson mixed glm. You specify a reduced and full model formula to extract p values and effect sizes.</p>
<p>Recommended: The function accepts an argument ‘celltype_genes_test’ this is a named list indexed by celltypes.</p>
<p>First we load a single cell object an define highly variable genes within each celltype, this can be done many different ways.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># Single cell mixed model. </span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyverse))</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(scglmmr)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">1990</span>)</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">datapath =<span class="st"> 'your_path_to_save_results'</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">s =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">'path_to_seurat_or_SingleCellExperimentObject'</span>)</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="co"># define highly variable genes within each cell type </span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">gene_list =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>()</a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(s<span class="op">@</span>meta.data<span class="op">$</span>celltype))) {</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">  gene_list[[i]] =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(s, celltype_joint <span class="op">==</span><span class="st"> </span>celltype_unique[i]) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="st">    </span>Seurat<span class="op">::</span><span class="kw">FindVariableFeatures</span>(x[[i]],<span class="dt">top.genes =</span> <span class="dv">10000</span>)</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">  gene_list[[i]] =<span class="st"> </span>Seurat<span class="op">::</span><span class="kw">VariableGenes</span>(gene_list[[i]])</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb2-16" data-line-number="16"></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="co"># one can also use scran trendVar etc. </span></a></code></pre></div>
<p>Now we run the single cell Poisson model by specifying a model formula, the formula must have the LHS equal to <code>gene ~</code> and include a random effect term <code>(1|subjectid)</code>. the variable that corresponds to the perturbation variable as a 2 level factor with pre and post perturbation measurements (repeated measurements for the same subject denoted by <code>subjectid</code> must be identified, for example, if the metadata variable coding for the time post perturbation is called treatment.time, then the model formula could be <code>f1 = 'gene ~ offset(log(nUMI)) + treatment.time + (1|subjectid)'</code> with this model one would set the argument <code>test_variable = treatment.time</code> which should have 2 ordered levels corresponding to pre and post treatment. Within the function, the <code>emmeans</code> package automatically tests the difference in the marginal means of the post vs pre perturbation effect.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co"># load subset of genes to test for each celltype </span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">gene_union =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(genes_test))</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co"># create day 1 metadata dataframe from a single cell object (seurat, SingleCellExperiment etc.)</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">s<span class="op">@</span>meta.data<span class="op">$</span>subjectid =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(s<span class="op">@</span>meta.data<span class="op">$</span>sampleid))</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co"># create metadata for lme4</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">md =<span class="st"> </span>s<span class="op">@</span>meta.data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dplyr/man/select.html">select</a></span>(barcode_check, batch, subjectid, timepoint, celltype_joint, nUMI) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">timepoint =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(timepoint, <span class="dt">levels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"d0"</span>, <span class="st">"d1"</span>))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">celltype =</span> celltype_joint) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="st">  </span><span class="kw">column_to_rownames</span>(<span class="st">'barcode_check'</span>)</a>
<a class="sourceLine" id="cb3-14" data-line-number="14"></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co"># get gene data </span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16">gene_data =<span class="st"> </span>Matrix<span class="op">::</span><span class="kw">t</span>(s<span class="op">@</span>raw.data[gene_union, ])</a>
<a class="sourceLine" id="cb3-17" data-line-number="17"></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="co"># we can now remove whatever single cell object was loaded in the environment. </span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="kw"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(s); <span class="kw"><a href="https://rdrr.io/r/base/gc.html">gc</a></span>()</a>
<a class="sourceLine" id="cb3-20" data-line-number="20"></a>
<a class="sourceLine" id="cb3-21" data-line-number="21"><span class="co">## specify model formula </span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22">f1 =<span class="st"> 'gene ~ offset(log(nUMI)) + timepoint + (1|subjectid)'</span></a>
<a class="sourceLine" id="cb3-23" data-line-number="23"></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="co"># method 1</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25">results =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/scglmmr/man/SCMixedPoisson.html">SCMixedPoisson</a></span>(<span class="dt">gene_data =</span> gene_data,</a>
<a class="sourceLine" id="cb3-26" data-line-number="26">                                  <span class="dt">metadata =</span> md,</a>
<a class="sourceLine" id="cb3-27" data-line-number="27">                                  <span class="dt">model_formula =</span> f1, </a>
<a class="sourceLine" id="cb3-28" data-line-number="28">                                  <span class="dt">test_variable =</span> <span class="st">'timepoint'</span>,</a>
<a class="sourceLine" id="cb3-29" data-line-number="29">                                  <span class="dt">celltype_genes_test =</span> genes_test,</a>
<a class="sourceLine" id="cb3-30" data-line-number="30">                                  <span class="dt">save_path =</span> datapath)</a>
<a class="sourceLine" id="cb3-31" data-line-number="31"><span class="co"># write results </span></a>
<a class="sourceLine" id="cb3-32" data-line-number="32"><span class="co"># data.table::fwrite(x = results,file = paste0(datapath, "/h1_sc_time_merged_v2.txt"), sep = '\t')</span></a></code></pre></div>
<p>Another way to specify the model automatically:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">results =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/scglmmr/man/SCMixedPoisson.html">SCMixedPoisson</a></span>(<span class="dt">gene_data =</span> gene_data,</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">                                  <span class="dt">metadata =</span> md,</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">                                  <span class="dt">test_variable =</span> <span class="st">'timepoint'</span>,</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">                                  <span class="dt">covariate_variables =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'BMI'</span>, <span class="st">'SEX'</span>),</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">                                  <span class="dt">celltype_genes_test =</span> genes_test, </a>
<a class="sourceLine" id="cb4-6" data-line-number="6">                                  <span class="dt">save_path =</span> datapath)</a></code></pre></div>
<p>This would automatically test the delta for pre and post perturbation calculating the marginal means over the coavariates BMI and SEX with the generalized linear mixed effects Poisson model: <code>'gene ~ BMI + SEX + timepoint + (1|subjectid)'</code>.</p>
</div>
<div id="enrichment-of-single-cell-poisson-model-of-timepoint-effect-using-clusterprofiler" class="section level3">
<h3 class="hasAnchor">
<a href="#enrichment-of-single-cell-poisson-model-of-timepoint-effect-using-clusterprofiler" class="anchor"></a>enrichment of single cell poisson model of timepoint effect using clusterprofiler</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co">## enrichment on these results </span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">### plot enrichment with a hypergeometric test against the li BTM </span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">scd1 =<span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/split.html">split</a></span>( results , <span class="dt">f =</span> mmres<span class="op">$</span>celltype )</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">scd1 =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(scd1, <span class="cf">function</span>(x){x <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="st">    </span>dplyr<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dplyr/man/select.html">select</a></span>(gene, celltype, estimate, padj)  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="st">    </span>dplyr<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/dplyr/man/select.html">rename</a></span>(<span class="st">'logFC'</span>=<span class="st"> </span>fixed_effect,  <span class="st">'P.Value'</span> =<span class="st"> </span>padj) })</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="kw"><a href="https://rdrr.io/r/base/load.html">load</a></span>(termdf)</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">hypsc =<span class="st"> </span>scglmmr<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/scglmmr/man/RunHypergeometricTest.html">RunHypergeometricTest</a></span>(<span class="dt">result_list =</span> scd1, </a>
<a class="sourceLine" id="cb5-12" data-line-number="12">                                       <span class="dt">TERM2GENE_dataframe =</span> term_df,</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">                                       <span class="dt">pval_threshold =</span> <span class="fl">0.05</span>,</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">                                       <span class="dt">logFC_threshold =</span> <span class="fl">0.1</span>)  </a>
<a class="sourceLine" id="cb5-15" data-line-number="15">scglmmr<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/scglmmr/man/PlotHypergeometric.html">PlotHypergeometric</a></span>(<span class="dt">hyperg_result =</span> hypsc,</a>
<a class="sourceLine" id="cb5-16" data-line-number="16">                            <span class="dt">p.adjust.filter =</span> <span class="fl">0.05</span>,</a>
<a class="sourceLine" id="cb5-17" data-line-number="17">                            <span class="dt">genenumber_filter =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb5-18" data-line-number="18">                            <span class="dt">savepath =</span> figpath, </a>
<a class="sourceLine" id="cb5-19" data-line-number="19">                            <span class="dt">savename =</span> <span class="st">"d1singlecell_hypergeometric_padj0.05.pdf"</span>, </a>
<a class="sourceLine" id="cb5-20" data-line-number="20">                            <span class="dt">title =</span> <span class="st">"single cell 24h vs baseline gene_exprs ~ offset(nUMI) + timepoint + (1|subjectid) </span><span class="ch">\n</span><span class="st"> </span></a>
<a class="sourceLine" id="cb5-21" data-line-number="21"><span class="st">                            hypergeometric test LI BTM, FDR 0.05, gene filter n &gt; 2"</span>, </a>
<a class="sourceLine" id="cb5-22" data-line-number="22">                            <span class="dt">height =</span> <span class="fl">5.5</span>, <span class="dt">width =</span> <span class="dv">8</span>)</a></code></pre></div>
</div>
<div id="single-cell-module-level-testing-group-level-fold-change-comparisons" class="section level3">
<h3 class="hasAnchor">
<a href="#single-cell-module-level-testing-group-level-fold-change-comparisons" class="anchor"></a>2. Single cell module level testing + group level fold change comparisons</h3>
<p>This is designed for testing the difference in single cell module activity scores between groups at baseline, between groups, post treatment across groups and the difference in treatment effect between groups using the same <em>a priori</em> contrast approach as in the pseudobulk method described above.</p>
<div id="part-i" class="section level4">
<h4 class="hasAnchor">
<a href="#part-i" class="anchor"></a>Part I</h4>
<p>You first fit a module score to each single cell. Options: <em>threshold</em> what percent of genes in the module must a cell express to get a score (i.e. of 0.1, if the cell has less than 10% of genes &gt;0 in the module don’t score) <em>return_weighted</em> whether to return the weighted module score which is the average * weight where weight = number of genes in the cell in that module with non-zeroexpression</p>
<p><em>cellwise_scaling</em> should the scores be scaled across cells? Not recommended unless you are testing only a single celltype. <em>Seurat_version</em> if this is set to “2” it will accomodate seurat v2, if set to “3” will accomodate v3</p>
</div>
<div id="part-ii-fitting-models" class="section level4">
<h4 class="hasAnchor">
<a href="#part-ii-fitting-models" class="anchor"></a>Part II fitting models:</h4>
<p><em>The SCGroupContrastGLMM Function</em> To simultaneously test the difference in the fold changes due to treatment (for example) the levels of the combined group + time factor "group_id have to be ordered as follows (can be any names, these are just the order): group1 timepoint 0, group1 timepoint 1, group2 timepoint 0, group2 timepoint 1</p>
<p>It is also possible to use custom contrasts by changing the argument to contrast_list from contrast_2 (automatically loaded) to something else.</p>
<p>Specify any lme4 model formula in the argument to f1, with the randomeffect term for subjectid set to <code>(1|sampleid)</code> which should have a pre and post perturbation measurement. <code>f1 = 'modulescore ~ age + gender +  group_id + (1|sampleid)'</code></p>
<p>This function will also automatically save a helpful plot of the least squares means (the residual means of each group after accounting for covariates in the model) of the module over the levels of each combined group_timepoint factor.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co"># load data</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">Seurat =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"my_seurat_object.rds"</span>)</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co"># add cellwise module score for each signature </span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">mod_scores =<span class="st"> </span><span class="kw"><a href="../reference/WeightedCellModuleScore.html">WeightedCellModuleScore</a></span>(<span class="dt">seurat_object =</span> Seurat,</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">                                     <span class="dt">module_list =</span> btm,</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">                                     <span class="dt">threshold =</span> <span class="fl">0.1</span>,</a>
<a class="sourceLine" id="cb6-9" data-line-number="9">                                     <span class="dt">return_weighted =</span> <span class="ot">FALSE</span>, <span class="dt">cellwise_scaling =</span> <span class="ot">FALSE</span>, </a>
<a class="sourceLine" id="cb6-10" data-line-number="10">                                     <span class="dt">Seurat_version =</span> <span class="st">"2"</span>) </a>
<a class="sourceLine" id="cb6-11" data-line-number="11">Seurat =<span class="st"> </span><span class="kw">AddMetaData</span>(Seurat,<span class="dt">metadata =</span> mod_scores)</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">module_n =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(sig_test)</a>
<a class="sourceLine" id="cb6-13" data-line-number="13"></a>
<a class="sourceLine" id="cb6-14" data-line-number="14"><span class="co"># set up module data frame </span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15">module_df =<span class="st"> </span>Seurat<span class="op">@</span>meta.data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(barcode_check, celltype_joint, module_n) </a>
<a class="sourceLine" id="cb6-16" data-line-number="16"></a>
<a class="sourceLine" id="cb6-17" data-line-number="17"><span class="co"># format metadata as factors group_id is order leveled for contrast_fit = contrast(emm1, method = list( (c21 - c20) - (c11 - c10) ))</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18">md =<span class="st"> </span>Seurat<span class="op">@</span>meta.data <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group_id =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(adjmfc.time,  <span class="dt">levels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'d0 low'</span>, <span class="st">'d1 low'</span>, <span class="st">'d0 high'</span>, <span class="st">'d1 high'</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">sampleid =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(sampleid)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-21" data-line-number="21"><span class="st">  </span><span class="kw">select</span>(barcode_check, celltype_joint, sampleid,  age, group_id)</a>
<a class="sourceLine" id="cb6-22" data-line-number="22"></a>
<a class="sourceLine" id="cb6-23" data-line-number="23"><span class="co"># Fit mixed model </span></a>
<a class="sourceLine" id="cb6-24" data-line-number="24">plot_savepath =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(my_figure_save_path, <span class="st">"/marginalmeans/"</span>); <span class="kw"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(plot_savepath)</a>
<a class="sourceLine" id="cb6-25" data-line-number="25"></a>
<a class="sourceLine" id="cb6-26" data-line-number="26"><span class="co"># specify any random intercept model e.g.</span></a>
<a class="sourceLine" id="cb6-27" data-line-number="27">f1 =<span class="st"> 'modulescore ~ age + group_id + (1|sampleid)'</span></a>
<a class="sourceLine" id="cb6-28" data-line-number="28"></a>
<a class="sourceLine" id="cb6-29" data-line-number="29"><span class="co"># fit sc mod mixed model on ewighted module scores. </span></a>
<a class="sourceLine" id="cb6-30" data-line-number="30">mm_res =<span class="st"> </span><span class="kw">FitModuleMixModel</span>(<span class="dt">module_data_frame =</span> module_df, </a>
<a class="sourceLine" id="cb6-31" data-line-number="31">                           <span class="dt">celltype_column =</span> <span class="st">'celltype'</span>,</a>
<a class="sourceLine" id="cb6-32" data-line-number="32">                           <span class="dt">metadata =</span> md,</a>
<a class="sourceLine" id="cb6-33" data-line-number="33">                           <span class="dt">fixed_effects =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb6-34" data-line-number="34">                           <span class="dt">lmer_formula =</span> f1,</a>
<a class="sourceLine" id="cb6-35" data-line-number="35">                           <span class="dt">plotdatqc =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb6-36" data-line-number="36">                           <span class="dt">figpath =</span> <span class="st">'your/file/path'</span>)</a>
<a class="sourceLine" id="cb6-37" data-line-number="37"></a>
<a class="sourceLine" id="cb6-38" data-line-number="38"><span class="co">### This function returns p values, effect sizes for baseline and difference in fld changes between the groups </span></a>
<a class="sourceLine" id="cb6-39" data-line-number="39"><span class="kw"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(mmres)</a>
<a class="sourceLine" id="cb6-40" data-line-number="40"><span class="co"># "celltype"                    "modulename"                  "contrasttime1vs0_group2vs1" </span></a>
<a class="sourceLine" id="cb6-41" data-line-number="41"><span class="co"># "estimatetime1vs0_group2vs1"  "std.errortime1vs0_group2vs1" "dftime1vs0_group2vs1"       </span></a>
<a class="sourceLine" id="cb6-42" data-line-number="42"><span class="co"># "z.ratiotime1vs0_group2vs1"   "p.valuetime1vs0_group2vs1"   "contrasttime0_group2vs1"    </span></a>
<a class="sourceLine" id="cb6-43" data-line-number="43"><span class="co"># "estimatetime0_group2vs1"     "std.errortime0_group2vs1"    "dftime0_group2vs1"          </span></a>
<a class="sourceLine" id="cb6-44" data-line-number="44"><span class="co"># "z.ratiotime0_group2vs1"      "p.valuetime0_group2vs1"      "d0 low_marginal_mean"       </span></a>
<a class="sourceLine" id="cb6-45" data-line-number="45"><span class="co"># "d1 low_marginal_mean"        "d0 high_marginal_mean"       "d1 high_marginal_mean"      </span></a>
<a class="sourceLine" id="cb6-46" data-line-number="46"><span class="co"># "formula"                     "statistictime1vs0_group2vs1" "statistictime0_group2vs1"   </span></a></code></pre></div>
<p>A plot like this will be generated for each module for each cell type with the estimated marginal means in the right margin and the actual single cell module score distribution across each level of group_id:</p>
<div class="figure">
<img src="https://user-images.githubusercontent.com/15280712/89591805-1f5a1200-d819-11ea-8b49-5b84477dd178.png" alt="image"><p class="caption">image</p>
</div>
<p><em>The WilcoxWithinCluster function</em> To run a simple test of baseline differences between groups, use the <em>WilcoxWithinCluster</em> function as below if you only have one timepoint but 2 outcome groups.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">######## baseline differences with a simple wilcox test </span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">weighted_score =<span class="st"> </span><span class="kw"><a href="../reference/WeightedCellModuleScore.html">WeightedCellModuleScore</a></span>(<span class="dt">seurat_object =</span> s, <span class="dt">module_list =</span> sig,</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">                                         <span class="dt">threshold =</span> <span class="fl">0.1</span>, <span class="dt">cellwise_scaling =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">                                         <span class="dt">return_weighted =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">                                         <span class="dt">Seurat_version =</span> <span class="st">"3"</span>)</a>
<a class="sourceLine" id="cb7-7" data-line-number="7"> </a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="co"># set module dataframe</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9">module_df =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="dt">celltype_joint =</span> <span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(s<span class="op">@</span>meta.data<span class="op">$</span>seurat_clusters),</a>
<a class="sourceLine" id="cb7-10" data-line-number="10">                  <span class="dt">barcode_check =</span> s<span class="op">@</span>meta.data<span class="op">$</span>barcode_full,</a>
<a class="sourceLine" id="cb7-11" data-line-number="11">                  weighted_score) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span>()</a>
<a class="sourceLine" id="cb7-13" data-line-number="13"> </a>
<a class="sourceLine" id="cb7-14" data-line-number="14"><span class="co"># format lme4 metadata (note here just wilcox so group IDS do not have to be lme4 factors</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15">meta_data =<span class="st"> </span>s<span class="op">@</span>meta.data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="st">  </span><span class="kw">select</span>(<span class="dt">celltype_joint =</span> seurat_clusters,  <span class="dt">barcode_check =</span> barcode_full, sample, <span class="dt">group_id =</span> IRAE) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(group_id <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"poor_outcome"</span>, <span class="st">"good_outcome"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group_id =</span> <span class="kw"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(group_id, <span class="dt">levels =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"poor_outcome"</span>, <span class="st">"good_outcome"</span>)))</a>
<a class="sourceLine" id="cb7-20" data-line-number="20"> </a>
<a class="sourceLine" id="cb7-21" data-line-number="21"><span class="co"># Fit wilcox test and do bonferonni correction </span></a>
<a class="sourceLine" id="cb7-22" data-line-number="22">plot_savepath2 =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(figpath, <span class="st">"module_distribution/"</span>); <span class="kw"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(plot_savepath2)</a>
<a class="sourceLine" id="cb7-23" data-line-number="23">m2 =<span class="st"> </span>module_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(barcode_check <span class="op">%in%</span><span class="st"> </span>meta_data<span class="op">$</span>barcode_check )</a>
<a class="sourceLine" id="cb7-24" data-line-number="24">cvnc =<span class="st"> </span><span class="kw"><a href="../reference/WilcoxWithinCluster.html">WilcoxWithinCluster</a></span>(<span class="dt">module_data_frame =</span> m2, <span class="dt">lme4metadata =</span> meta_data, <span class="dt">plot_savepath =</span> plot_savepath2)</a>
<a class="sourceLine" id="cb7-25" data-line-number="25">cvnc<span class="op">$</span>padj =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span>(<span class="dt">p =</span> cvnc<span class="op">$</span>p.value.t0.wilcox, <span class="dt">method =</span> <span class="st">"BH"</span>)</a></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Matthew Mulè.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
