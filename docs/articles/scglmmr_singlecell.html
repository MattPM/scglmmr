<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Single cell gene and module differential expression with nested group repeated measures experiment designs • scglmmr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Single cell gene and module differential expression with nested group repeated measures experiment designs">
<meta property="og:description" content="scglmmr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">scglmmr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/pseudobulk_mixed_effects.html">Pseudobulk differential expression with nested group repeated measures single cell experiment design</a>
    </li>
    <li>
      <a href="../articles/scglmmr_singlecell.html">Single cell gene and module differential expression with nested group repeated measures experiment designs</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MattPM/scglmmr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Single cell gene and module differential
expression with nested group repeated measures experiment designs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/MattPM/scglmmr/blob/HEAD/vignettes/scglmmr_singlecell.Rmd" class="external-link"><code>vignettes/scglmmr_singlecell.Rmd</code></a></small>
      <div class="hidden name"><code>scglmmr_singlecell.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/MattPM/scglmmr" class="external-link">scglmmr</a></span><span class="op">)</span></code></pre></div>
<div class="section level3">
<h3 id="single-cell-gene-module-level-testing-">Single cell gene module level testing.<a class="anchor" aria-label="anchor" href="#single-cell-gene-module-level-testing-"></a>
</h3>
<p>Compare single cell level module score responses across groups. As in
the pseudobulk vignette, fit models within each cell type adjusting for
covariates using a random intercept term for each donor. Functions used
in this workflow include:</p>
<p><code>WeightedCellModuleScore</code> - score each module activity for
each cell; any method can be used here. Below we discuss relative vs
absolute scaling across cells vs within cell types for effect size
interpretation.</p>
<p><code>FitLmer</code> - fits a linear model using lme4 notation to the
module scores. Returns a nested list of model results that can be
queried to extract effects of interest.</p>
<p><code>FitLmerContrast</code> - as above, but specifically designed
for 2 group 2 timepoint repeated measures perturbation designs.
Automatically calculates baseline differences, treatment effect across
subjects and difference in treatment effects between groups using the <a href="https://cran.r-project.org/web/packages/emmeans/index.html" class="external-link">emmeans</a>
package.</p>
<p>A plot as shown below is generated for each module x cell type.</p>
<p><img src="../reference/figures/example_sc.png" heightt="300" width="300/"></p>
</div>
<div class="section level3">
<h3 id="load-and-normalize-single-cell-data">Load and normalize single cell data<a class="anchor" aria-label="anchor" href="#load-and-normalize-single-cell-data"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/MattPM/scglmmr" class="external-link">scglmmr</a></span><span class="op">)</span><span class="op">)</span>

<span class="co"># demonstrate using Seurat object</span>
<span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"singlecellobject.rds"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># create a vector of celltypes </span>
<span class="va">ct</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">s</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">celltype</span><span class="op">)</span>

<span class="co"># normalize with log normalization</span>
<span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Seurat/man/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="va">s</span>,normalization.method <span class="op">=</span> <span class="st">'LogNormalize'</span>,assay <span class="op">=</span> <span class="st">'RNA'</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="define-modules-to-fit">Define modules to fit<a class="anchor" aria-label="anchor" href="#define-modules-to-fit"></a>
</h3>
<p>These functions can be useful to further interrogate the pathways
identified in the pseudobulk pipeline or for unbiased analysis. Here for
demonstration purposes, a subset of the hallmark pathways are used.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sigs_test</span> <span class="op">=</span> <span class="va">hallmark</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">22</span>, <span class="fl">23</span>, <span class="fl">24</span>,<span class="fl">25</span>,<span class="fl">26</span>,<span class="fl">27</span><span class="op">)</span><span class="op">]</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="format-cell-metadata">Format cell metadata<a class="anchor" aria-label="anchor" href="#format-cell-metadata"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># format cell metadata as factors group_id is order leveled for: </span>
<span class="va">md</span> <span class="op">=</span> <span class="va">s</span><span class="op">@</span><span class="va">meta.data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">timepoint</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>group_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">timepoint</span>, sep <span class="op">=</span> <span class="st">'_'</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>group_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">group_id</span>,  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'0_0'</span>, <span class="st">'0_1'</span>, <span class="st">'1_0'</span>, <span class="st">'1_1'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">celltype</span>, <span class="va">subjectid</span>, <span class="va">sex</span> , <span class="va">age</span>, <span class="va">timepoint</span>, <span class="va">group_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="quality-control-cell-types-to-be-fit">Quality control cell types to be fit<a class="anchor" aria-label="anchor" href="#quality-control-cell-types-to-be-fit"></a>
</h3>
<p>If a cell type is very donor specific such that there are only cells
for a couple of subjects we cant interpret the group level effects so we
remove these cell types.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># qc data to remove celltypes with no cells for some subhects at both timepoints </span>
<span class="co"># keeps MLE more stable for the estimates of random intercept </span>
<span class="va">ct.si</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">md</span><span class="op">$</span><span class="va">celltype</span>, <span class="va">md</span><span class="op">$</span><span class="va">subjectid</span><span class="op">)</span> , <span class="fl">1</span>, <span class="va">min</span><span class="op">)</span> 
<span class="va">c.keep</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ct.si</span><span class="op">[</span><span class="va">ct.si</span> <span class="op">&gt;</span> <span class="fl">7</span><span class="op">]</span><span class="op">)</span>
<span class="va">md</span> <span class="op">=</span> <span class="va">md</span><span class="op">[</span><span class="va">md</span><span class="op">$</span><span class="va">celltype</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">c.keep</span>, <span class="op">]</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="calculate-module-scores">Calculate module scores<a class="anchor" aria-label="anchor" href="#calculate-module-scores"></a>
</h3>
<p>This can be done in multiple ways. The function below calculates the
simple average. Note that for interpretability of the efects within each
cluster, the score is being applied and scaled within each cell
type.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># add single cell weighted module scores</span>
<span class="co"># split to standardize within cell type </span>
<span class="va">ct.md</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">md</span>, f <span class="op">=</span> <span class="va">md</span><span class="op">$</span><span class="va">celltype</span><span class="op">)</span>

<span class="co"># get umi data </span>
<span class="va">umi</span> <span class="op">=</span> <span class="va">s</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">@</span><span class="va">data</span><span class="op">[</span> ,<span class="fu"><a href="https://rdrr.io/pkg/tibble/man/rownames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">md</span><span class="op">)</span><span class="op">]</span>

<span class="co"># fit module scores </span>
<span class="va">mod_scores</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">ct.md</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span> 
  <span class="fu">scglmmr</span><span class="fu">::</span><span class="fu"><a href="../reference/WeightedCellModuleScore.html">WeightedCellModuleScore</a></span><span class="op">(</span>gene_matrix <span class="op">=</span> <span class="va">umi</span><span class="op">[</span> ,<span class="fu"><a href="https://rdrr.io/pkg/tibble/man/rownames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span>, 
                                   module_list <span class="op">=</span> <span class="va">sigs_test</span>, 
                                   threshold <span class="op">=</span> <span class="fl">0</span>,
                                   <span class="co"># standardize within protein celltype</span>
                                   cellwise_scaling <span class="op">=</span> <span class="cn">TRUE</span>, 
                                   return_weighted <span class="op">=</span> <span class="cn">FALSE</span> <span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
<span class="va">ms</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/dplyr/man/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">mod_scores</span><span class="op">)</span>

<span class="co"># correctly order rows after the split. </span>
<span class="va">ms</span> <span class="op">=</span> <span class="va">ms</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tibble/man/rownames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">md</span><span class="op">)</span>, table <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tibble/man/rownames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">ms</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/tibble/man/rownames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">ms</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/tibble/man/rownames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">md</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fit-modules">Fit modules<a class="anchor" aria-label="anchor" href="#fit-modules"></a>
</h3>
<p>Specify a model using lme4 notation and fit models. Note that the LHS
outcome “modulescore” should not be changed as this is adaptively
applied to each module internally.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R">

<span class="co"># specify model </span>
<span class="va">f1</span> <span class="op">=</span> <span class="st">'modulescore ~ 0 + timepoint + age + sex + (1|subjectid)'</span>

<span class="co"># specify a path to save plots </span>
<span class="va">plot_savepath</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/here/man/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">'/mypath/'</span><span class="op">)</span>


<span class="co"># fit sc mod mixed model on ewighted module scores. </span>
<span class="va">mmres</span> <span class="op">=</span> <span class="fu"><a href="../reference/FitLmer.html">FitLmer</a></span><span class="op">(</span>module_data_frame <span class="op">=</span> <span class="va">ms</span>,
                celltype_column <span class="op">=</span> <span class="st">'celltype'</span>,
                metadata <span class="op">=</span> <span class="va">md</span>, 
                lme4.formula <span class="op">=</span> <span class="va">f1</span><span class="op">)</span>
  </code></pre></div>
</div>
<div class="section level3">
<h3 id="examine-results">Examine results<a class="anchor" aria-label="anchor" href="#examine-results"></a>
</h3>
<p>Results are formatted as a list indexed by cell type. If we want to
find the effects of time on expression we can use the following code to
extract out this effect as shown below using the emmeans package. This
allows maximum flexibility since any effect can be extracted and custom
contrast matrices can be utilized – see emmeans documentation.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># write wrapper to extract out time effect.</span>
<span class="va">extract.time.effect</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit.list.celltype</span><span class="op">)</span><span class="op">{</span> 
  <span class="va">c_res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">u</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">fit.list.celltype</span><span class="op">)</span><span class="op">)</span><span class="op">{</span> 
    <span class="va">emm1</span> <span class="op">=</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span>
        <span class="fu">emmeans</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/emmeans.html" class="external-link">emmeans</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">m1</span>, specs <span class="op">=</span> <span class="op">~</span> <span class="va">timepoint</span> , data <span class="op">=</span> <span class="va">res</span>, lmer.df <span class="op">=</span> <span class="st">"asymptotic"</span><span class="op">)</span>,
        error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>
        <span class="op">)</span>
    <span class="va">c_res</span><span class="op">[[</span><span class="va">u</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="va">emm1</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="co"># now we can apply this to each cell type. </span>
<span class="va">time.result</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mmres</span> , <span class="va">extract.time.effect</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="a-custom-function-for-automatically-extracting-effects-from-a-2-group-repeated-measures-treatment-design">a custom function for automatically extracting effects from a 2
group repeated measures treatment design<a class="anchor" aria-label="anchor" href="#a-custom-function-for-automatically-extracting-effects-from-a-2-group-repeated-measures-treatment-design"></a>
</h3>
<p>This function was written for a 2 group design (as shown in the main
readme) where subjects each have a pre and post perturbation
measurement. WE wantto compare the pertuebation effects across subjects,
and between groups and test the baseline differences. All of these
effects are extracted automatically into a simple output, and plots are
created as above.<br>
For this function, on the RHS, + (1|subjectid) should also not be
changed. One can also specify fixed effects covariates as a vector.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">f1</span> <span class="op">=</span> <span class="st">'modulescore ~ 0 + groupid + age + sex + (1|subjectid)'</span>

<span class="co"># fit sc mod mixed model on ewighted module scores. </span>
<span class="va">mm_res.m1</span> <span class="op">=</span> <span class="fu"><a href="../reference/FitLmerContrast.html">FitLmerContrast</a></span><span class="op">(</span>module_data_frame <span class="op">=</span> <span class="va">ms</span>, 
                            celltype_column <span class="op">=</span> <span class="st">'celltype'</span>, 
                            metadata <span class="op">=</span> <span class="va">md</span>, 
                            lmer_formula <span class="op">=</span> <span class="va">f1</span>, 
                            plotdatqc <span class="op">=</span> <span class="cn">TRUE</span>, 
                            fixed_effects <span class="op">=</span> <span class="cn">NULL</span>,
                            figpath <span class="op">=</span> <span class="va">plot_savepath</span><span class="op">)</span>
<span class="co"># saveRDS(mm_res.m1,file = paste0(datapath, "mm_res.m1.rds"))</span></code></pre></div>
<p>Note that the effect size of specific module scores may be compared
using the code below to determine which celltype has the greatest
<em>absolute</em> effect size (epression) of a given module. Both the
between and within cell type expression group level differences are
likely of interest for interpretation.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ms.full</span> <span class="op">=</span> <span class="fu">scglmmr</span><span class="fu">::</span><span class="fu"><a href="../reference/WeightedCellModuleScore.html">WeightedCellModuleScore</a></span><span class="op">(</span>
  gene_matrix <span class="op">=</span> <span class="va">umi</span>, 
  module_list <span class="op">=</span> <span class="va">sigs_test</span>, 
  threshold <span class="op">=</span> <span class="fl">0</span>,
  <span class="co"># standardize within protein celltype</span>
  cellwise_scaling <span class="op">=</span> <span class="cn">TRUE</span>, 
  return_weighted <span class="op">=</span> <span class="cn">FALSE</span> 
  <span class="op">)</span>

<span class="va">d</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">ms.full</span>, <span class="va">md</span><span class="op">)</span>

<span class="co"># absolute effect size for hallmark </span>
<span class="va">f1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="va">HALLMARK_HYPOXIA</span> <span class="op">~</span> <span class="va">celltype</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">subjecctID</span><span class="op">)</span><span class="op">)</span>
<span class="va">m1</span> <span class="op">=</span> <span class="fu">lme4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">f1</span>, data <span class="op">=</span> <span class="va">bl</span><span class="op">)</span>
<span class="va">emm1</span> <span class="op">=</span> <span class="fu">emmeans</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/emmeans.html" class="external-link">emmeans</a></span><span class="op">(</span><span class="va">m1</span>, specs <span class="op">=</span> <span class="op">~</span><span class="va">celltype</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">emm1</span><span class="op">)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Matthew Mulè.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
